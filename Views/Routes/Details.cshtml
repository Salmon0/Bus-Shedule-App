@model BusRoute

@{
    ViewData["Title"] = "Детали маршрута";
    var userId = Context.Session.GetInt32("UserId");
}

<div class="container mt-4">
    <h1>@ViewData["Title"]</h1>

    <div class="card mt-3">
        <div class="card-header bg-primary text-white">
            <h4>@Model.DepartureCity → @Model.ArrivalCity</h4>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-3">Номер автобуса:</dt>
                <dd class="col-sm-9">@Model.BusNumber</dd>

                <dt class="col-sm-3">Отправление:</dt>
                <dd class="col-sm-9">@Model.DepartureTime.ToString("f")</dd>

                <dt class="col-sm-3">Прибытие:</dt>
                <dd class="col-sm-9">@Model.ArrivalTime.ToString("f")</dd>

                <dt class="col-sm-3">Продолжительность:</dt>
                <dd class="col-sm-9">@Model.GetDuration().Hours ч @Model.GetDuration().Minutes мин</dd>

                <dt class="col-sm-3">Цена:</dt>
                <dd class="col-sm-9">@Model.Price.ToString("C")</dd>

                <dt class="col-sm-3">Свободные места:</dt>
                <dd class="col-sm-9">@Model.AvailableSeats</dd>
            </dl>
        </div>
    </div>

    <div class="mt-3">
        <a asp-action="Index" class="btn btn-secondary">Назад</a>
        @if (userId != null)
        {
            <form asp-action="Purchase" asp-controller="Tickets" method="post" class="d-inline">
                <input type="hidden" name="routeId" value="@Model.Id" />
                <select name="seatNumber" class="form-select d-inline w-auto me-2" required>
                    <option value="" disabled selected>Выберите место</option>
                    @{
                        // Получаем список занятых мест
                        var takenSeats = Model.Tickets.Where(t => t.Status != "Отменен").Select(t => t.SeatNumber).ToList();
                        var allSeats = Enumerable.Range(1, Model.AvailableSeats + takenSeats.Count);
                        var freeSeats = allSeats.Where(s => !takenSeats.Contains(s)).ToList();
                    }
                    @foreach (var seat in freeSeats)
                    {
                        <option value="@seat">@seat</option>
                    }
                </select>
                <button type="submit" class="btn btn-primary">Купить билет</button>
            </form>
        }
        else
        {
            <a asp-action="Login" asp-controller="Account" class="btn btn-warning">Войти для покупки</a>
        }
    </div>
</div>